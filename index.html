<!DOCTYPE html>
<html lang="id">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Dashboard - D-Takah Kemenhan</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
  </head>
  <body>
    <div class="dashboard-overview">
      <!-- Sidebar placeholder -->
      <div id="sidebar-placeholder"></div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header Placeholder - SEKARANG PAKAI PLACEHOLDER -->
        <div id="header-placeholder"></div>

        <!-- Content Container -->
        <div class="content-container">
          <!-- Stats Cards -->
          <div class="stats-cards">
            <div class="stat-card blue">
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Masuk</div>
                <div class="stat-card-value" id="statSuratMasuk">0</div>
                <div class="stat-card-change" id="changeSuratMasuk">+0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-envelope-fill"></i>
              </div>
            </div>

            <div class="stat-card red">
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Keluar</div>
                <div class="stat-card-value" id="statSuratKeluar">0</div>
                <div class="stat-card-change" id="changeSuratKeluar">+0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-send-fill"></i>
              </div>
            </div>

            <div class="stat-card maroon">
              <div class="stat-card-content">
                <div class="stat-card-title">Arsip</div>
                <div class="stat-card-value" id="statArsip">0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-folder-fill"></i>
              </div>
            </div>

            <div class="stat-card light-blue">
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Nota Dinas</div>
                <div class="stat-card-value" id="statNotaDinas">0</div>
                <div class="stat-card-change" id="changeNotaDinas">+0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-file-text-fill"></i>
              </div>
            </div>
          </div>

          <!-- Dashboard Summary -->
          <div class="dashboard-summary">
            <div class="summary-header">
              <h2 class="summary-title">Dashboard Summary Activity Document</h2>
            </div>
            <div class="summary-content">
              <div class="progress-section">
                <div class="progress-box blue-bg">
                  <div class="progress-label blue">Surat Sudah Diaksi</div>
                  <div class="progress-value" id="progressSudahDiaksi">0%</div>
                </div>
                <div class="progress-box red-bg">
                  <div class="progress-label red">Surat Belum Diaksi</div>
                  <div class="progress-value red" id="progressBelumDiaksi">
                    0%
                  </div>
                </div>
              </div>

              <div class="circular-cards">
                <div class="circular-card blue">
                  <div class="circular-card-title">Surat Masuk</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text" id="percentSuratMasuk">
                      0%
                    </div>
                  </div>
                </div>
                <div class="circular-card green">
                  <div class="circular-card-title">Surat Keluar</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text" id="percentSuratKeluar">
                      0%
                    </div>
                  </div>
                </div>
                <div class="circular-card yellow">
                  <div class="circular-card-title">Surat Nota Dinas</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text" id="percentNotaDinas">
                      0%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Monitoring Surat Table -->
          <div class="monitoring-section">
            <div class="monitoring-header">
              <h3 class="monitoring-title">Monitoring Surat</h3>
              <select class="month-selector" id="monthSelector">
                <option value="all">Semua Bulan</option>
                <option value="0">Januari</option>
                <option value="1">Februari</option>
                <option value="2">Maret</option>
                <option value="3">April</option>
                <option value="4">Mei</option>
                <option value="5">Juni</option>
                <option value="6">Juli</option>
                <option value="7">Agustus</option>
                <option value="8">September</option>
                <option value="9">Oktober</option>
                <option value="10">November</option>
                <option value="11">Desember</option>
              </select>
            </div>
            <table class="monitoring-table">
              <thead>
                <tr>
                  <th>Dari</th>
                  <th>Nomor Agenda Surat</th>
                  <th>Nomor Surat</th>
                  <th>Kepada</th>
                  <th>Perihal</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="monitoringTableBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px">
                    Loading data...
                  </td>
                </tr>
              </tbody>
            </table>
            <a href="monitoring.html" class="more-link"
              >Lihat Selengkapnya...</a
            >
          </div>

          <!-- Footer -->
          <div id="footer-placeholder"></div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/database.js"></script>

    <!-- Page Initialization -->
    <script>
      console.log("üìÑ Dashboard Admin page loaded v3.0 - REALTIME");

      let unsubscribeMasuk = null;
      let unsubscribeKeluar = null;
      let unsubscribeNotaDinas = null;

      // Previous counts untuk menghitung perubahan
      let previousCounts = {
        masuk: 0,
        keluar: 0,
        notaDinas: 0,
      };

      // ========================================
      // INITIALIZE DASHBOARD
      // ========================================
      function initDashboard() {
        console.log("üöÄ Initializing realtime dashboard...");

        // Check authentication and role
        checkUserRole(["admin"])
          .then((userData) => {
            console.log("‚úÖ Admin access granted:", userData);

            // Display user info
            const userNameDisplay = document.getElementById("userNameDisplay");
            if (userNameDisplay) {
              userNameDisplay.textContent = userData.nama || userData.email;
            }

            // Load includes (sidebar, footer)
            if (window.loadIncludes) {
              window.loadIncludes();
            }

            // Load dashboard data with real-time listeners
            loadDashboardStatsRealtime();

            // Setup month selector
            setupMonthSelector();
          })
          .catch((error) => {
            console.error("‚ùå Access denied:", error);
            // User will be redirected by checkUserRole
          });
      }

      // ========================================
      // SETUP MONTH SELECTOR
      // ========================================
      function setupMonthSelector() {
        const monthSelector = document.getElementById("monthSelector");
        if (monthSelector) {
          // Set current month
          const currentMonth = new Date().getMonth();
          monthSelector.value = currentMonth;

          monthSelector.addEventListener("change", () => {
            loadMonitoringTable();
          });
        }
      }

      // ========================================
      // ANIMATE VALUE CHANGE
      // ========================================
      function animateValueChange(element, newValue) {
        element.classList.add("updating");
        element.textContent = newValue;
        setTimeout(() => {
          element.classList.remove("updating");
        }, 500);
      }

      // ========================================
      // CALCULATE PERCENTAGES
      // ========================================
      function calculatePercentages(masukCount, keluarCount, notaDinasCount) {
        const total = masukCount + keluarCount + notaDinasCount;

        if (total === 0) {
          return {
            masuk: 0,
            keluar: 0,
            notaDinas: 0,
          };
        }

        return {
          masuk: Math.round((masukCount / total) * 100),
          keluar: Math.round((keluarCount / total) * 100),
          notaDinas: Math.round((notaDinasCount / total) * 100),
        };
      }

      // ========================================
      // UPDATE PROGRESS BARS
      // ========================================
      function updateProgressBars(masukCount, keluarCount, notaDinasCount) {
        // Query untuk status yang sudah diaksi (Selesai atau Proses)
        Promise.all([
          db
            .collection("surat_masuk")
            .where("isDeleted", "==", false)
            .where("status", "in", ["Selesai", "Proses"])
            .get(),
          db.collection("surat_keluar").where("isDeleted", "==", false).get(),
          db
            .collection("nota_dinas")
            .where("isDeleted", "==", false)
            .where("status", "in", ["Selesai", "Proses"])
            .get(),
        ]).then((results) => {
          const sudahDiaksi =
            results[0].size + results[1].size + results[2].size;
          const total = masukCount + keluarCount + notaDinasCount;
          const belumDiaksi = total - sudahDiaksi;

          const percentSudah =
            total > 0 ? Math.round((sudahDiaksi / total) * 100) : 0;
          const percentBelum =
            total > 0 ? Math.round((belumDiaksi / total) * 100) : 0;

          const elemSudah = document.getElementById("progressSudahDiaksi");
          const elemBelum = document.getElementById("progressBelumDiaksi");

          if (elemSudah) animateValueChange(elemSudah, percentSudah + "%");
          if (elemBelum) animateValueChange(elemBelum, percentBelum + "%");

          console.log(
            `üìä Progress: ${percentSudah}% sudah diaksi, ${percentBelum}% belum diaksi`
          );
        });
      }

      // ========================================
      // LOAD DASHBOARD STATISTICS - REAL-TIME
      // ========================================
      function loadDashboardStatsRealtime() {
        console.log("üìä Setting up real-time listeners...");

        let masukCount = 0;
        let keluarCount = 0;
        let notaDinasCount = 0;

        // Surat Masuk Listener
        if (unsubscribeMasuk) unsubscribeMasuk();
        unsubscribeMasuk = db
          .collection("surat_masuk")
          .where("isDeleted", "==", false)
          .onSnapshot(
            (snapshot) => {
              const count = snapshot.size;
              masukCount = count;

              const element = document.getElementById("statSuratMasuk");
              if (element) {
                animateValueChange(element, count);
              }

              // Update change indicator
              const change = count - previousCounts.masuk;
              const changeElement = document.getElementById("changeSuratMasuk");
              if (changeElement && previousCounts.masuk > 0) {
                changeElement.textContent = change >= 0 ? `+${change}` : change;
                changeElement.style.color = change >= 0 ? "#10b981" : "#ef4444";
              }
              previousCounts.masuk = count;

              console.log("üì® Surat Masuk:", count);

              // Update percentages
              const percentages = calculatePercentages(
                masukCount,
                keluarCount,
                notaDinasCount
              );
              const percentElement =
                document.getElementById("percentSuratMasuk");
              if (percentElement) {
                animateValueChange(percentElement, percentages.masuk + "%");
              }

              // Update progress bars
              updateProgressBars(masukCount, keluarCount, notaDinasCount);

              // Reload monitoring table
              loadMonitoringTable();
            },
            (error) => {
              console.error("‚ùå Error in Surat Masuk listener:", error);
            }
          );

        // Surat Keluar Listener
        if (unsubscribeKeluar) unsubscribeKeluar();
        unsubscribeKeluar = db
          .collection("surat_keluar")
          .where("isDeleted", "==", false)
          .onSnapshot(
            (snapshot) => {
              const count = snapshot.size;
              keluarCount = count;

              const element = document.getElementById("statSuratKeluar");
              if (element) {
                animateValueChange(element, count);
              }

              // Update change indicator
              const change = count - previousCounts.keluar;
              const changeElement =
                document.getElementById("changeSuratKeluar");
              if (changeElement && previousCounts.keluar > 0) {
                changeElement.textContent = change >= 0 ? `+${change}` : change;
                changeElement.style.color = change >= 0 ? "#10b981" : "#ef4444";
              }
              previousCounts.keluar = count;

              console.log("üì§ Surat Keluar:", count);

              // Update percentages
              const percentages = calculatePercentages(
                masukCount,
                keluarCount,
                notaDinasCount
              );
              const percentElement =
                document.getElementById("percentSuratKeluar");
              if (percentElement) {
                animateValueChange(percentElement, percentages.keluar + "%");
              }

              // Update progress bars
              updateProgressBars(masukCount, keluarCount, notaDinasCount);

              // Reload monitoring table
              loadMonitoringTable();
            },
            (error) => {
              console.error("‚ùå Error in Surat Keluar listener:", error);
            }
          );

        // Nota Dinas Listener
        if (unsubscribeNotaDinas) unsubscribeNotaDinas();
        unsubscribeNotaDinas = db
          .collection("nota_dinas")
          .where("isDeleted", "==", false)
          .onSnapshot(
            (snapshot) => {
              const count = snapshot.size;
              notaDinasCount = count;

              const element = document.getElementById("statNotaDinas");
              if (element) {
                animateValueChange(element, count);
              }

              // Update change indicator
              const change = count - previousCounts.notaDinas;
              const changeElement = document.getElementById("changeNotaDinas");
              if (changeElement && previousCounts.notaDinas > 0) {
                changeElement.textContent = change >= 0 ? `+${change}` : change;
                changeElement.style.color = change >= 0 ? "#10b981" : "#ef4444";
              }
              previousCounts.notaDinas = count;

              console.log("üìù Nota Dinas:", count);

              // Update percentages
              const percentages = calculatePercentages(
                masukCount,
                keluarCount,
                notaDinasCount
              );
              const percentElement =
                document.getElementById("percentNotaDinas");
              if (percentElement) {
                animateValueChange(percentElement, percentages.notaDinas + "%");
              }

              // Update progress bars
              updateProgressBars(masukCount, keluarCount, notaDinasCount);

              // Reload monitoring table
              loadMonitoringTable();
            },
            (error) => {
              console.error("‚ùå Error in Nota Dinas listener:", error);
            }
          );

        // Load Arsip (deleted documents) - Real-time
        loadArsipCountRealtime();
      }

      // ========================================
      // LOAD ARSIP COUNT - REAL-TIME
      // ========================================
      function loadArsipCountRealtime() {
        let arsipCount = 0;

        // Listen to all three collections for deleted items
        db.collection("surat_masuk")
          .where("isDeleted", "==", true)
          .onSnapshot((snapshot) => {
            arsipCount = snapshot.size;
            updateArsipDisplay();
          });

        db.collection("surat_keluar")
          .where("isDeleted", "==", true)
          .onSnapshot((snapshot) => {
            arsipCount += snapshot.size;
            updateArsipDisplay();
          });

        db.collection("nota_dinas")
          .where("isDeleted", "==", true)
          .onSnapshot((snapshot) => {
            arsipCount += snapshot.size;
            updateArsipDisplay();
          });

        function updateArsipDisplay() {
          const element = document.getElementById("statArsip");
          if (element) {
            animateValueChange(element, arsipCount);
          }
          console.log("üóÑÔ∏è Arsip:", arsipCount);
        }
      }

      // ========================================
      // LOAD MONITORING TABLE
      // ========================================
      function loadMonitoringTable() {
        const tbody = document.getElementById("monitoringTableBody");
        const monthSelector = document.getElementById("monthSelector");

        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Loading...</td></tr>';

        const selectedMonth = monthSelector ? monthSelector.value : "all";

        Promise.all([
          db.collection("surat_masuk").where("isDeleted", "==", false).get(),
          db.collection("surat_keluar").where("isDeleted", "==", false).get(),
          db.collection("nota_dinas").where("isDeleted", "==", false).get(),
        ])
          .then((results) => {
            const allSurat = [];

            results[0].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "masuk",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            results[1].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "keluar",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            results[2].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "nota-dinas",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            // Filter by month if selected
            let filteredSurat = allSurat;
            if (selectedMonth !== "all") {
              const monthNum = parseInt(selectedMonth);
              filteredSurat = allSurat.filter((surat) => {
                return surat._createdAt.getMonth() === monthNum;
              });
            }

            // Sort by date (newest first)
            filteredSurat.sort((a, b) => b._createdAt - a._createdAt);

            // Take only 5 latest
            const latest5 = filteredSurat.slice(0, 5);

            if (latest5.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">Belum ada data surat</td></tr>';
              return;
            }

            tbody.innerHTML = latest5
              .map((surat) => {
                const dari = surat.dari || surat.namaPengirim || "N/A";
                const noSurat = surat.noSurat || surat.noNaskah || "N/A";
                const kepada = surat.kepada || surat.tujuan || "N/A";
                const perihal = surat.perihal || "N/A";
                const status = surat.status || "Pending";
                const statusClass = getStatusClass(status);

                return `
                <tr>
                  <td>
                    <span class="organization-icon">
                      <i class="bi bi-person-circle"></i>
                    </span>
                    ${dari}
                  </td>
                  <td>${surat.noAgenda || "-"}</td>
                  <td>${noSurat}</td>
                  <td>${kepada}</td>
                  <td>${perihal}</td>
                  <td>
                    <span class="status-badge ${statusClass}">
                      ${status}
                    </span>
                  </td>
                </tr>
              `;
              })
              .join("");

            console.log("‚úÖ Monitoring table updated");
          })
          .catch((error) => {
            console.error("‚ùå Error loading monitoring:", error);
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc2626;">Error loading data</td></tr>';
          });
      }

      function getStatusClass(status) {
        const statusMap = {
          Selesai: "selesai",
          Proses: "proses",
          Pending: "pending",
          Ditolak: "ditolak",
          Disetujui: "disetujui",
        };
        return statusMap[status] || "pending";
      }

      // ========================================
      // CLEANUP LISTENERS
      // ========================================
      window.addEventListener("beforeunload", () => {
        console.log("üßπ Cleaning up listeners...");
        if (unsubscribeMasuk) unsubscribeMasuk();
        if (unsubscribeKeluar) unsubscribeKeluar();
        if (unsubscribeNotaDinas) unsubscribeNotaDinas();
      });

      // ========================================
      // START INITIALIZATION
      // ========================================
      // Wait for auth.js to load
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initDashboard);
      } else {
        initDashboard();
      }

      console.log("‚úÖ Dashboard initialization script loaded v3.0 - REALTIME");
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Dashboard - D-Takah Kemenhan</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
    <style>
      /* ‚úÖ Clickable cards styling */
      .stat-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

      .stat-card:active {
        transform: translateY(-2px);
      }

      .circular-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .circular-card:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
      }

      /* ‚úÖ Progress bar animations */
      .progress-box {
        position: relative;
        overflow: hidden;
      }

      .progress-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .progress-box.updating::before {
        left: 100%;
      }

      /* ‚úÖ Value update animation */
      .stat-card-value.updating,
      .progress-value.updating,
      .circular-progress-text.updating {
        animation: pulse 0.5s ease-in-out;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* ‚úÖ IMPROVED: Compact Circular Progress Styling */
      .circular-progress {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto;
      }

      .circular-progress-ring {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
      }

      .circular-progress-ring circle {
        transition: stroke-dashoffset 0.6s ease;
      }

      .circular-progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
      }

      /* ‚úÖ Circular card improvements */
      .circular-cards {
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .circular-card {
        flex: 1;
        min-width: 200px;
        max-width: 280px;
        padding: 24px 20px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .circular-card-title {
        font-size: 16px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 16px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-overview">
      <!-- Sidebar placeholder -->
      <div id="sidebar-placeholder"></div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header Placeholder -->
        <div id="header-placeholder"></div>

        <!-- Content Container -->
        <div class="content-container">
          <!-- Stats Cards -->
          <div class="stats-cards">
            <div
              class="stat-card blue"
              onclick="navigateTo('surat-masuk.html')"
              title="Klik untuk melihat Surat Masuk"
            >
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Masuk</div>
                <div class="stat-card-value" id="statSuratMasuk">0</div>
                <div class="stat-card-change" id="changeSuratMasuk">+0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-envelope-fill"></i>
              </div>
            </div>

            <div
              class="stat-card red"
              onclick="navigateTo('surat-keluar.html')"
              title="Klik untuk melihat Surat Keluar"
            >
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Keluar</div>
                <div class="stat-card-value" id="statSuratKeluar">0</div>
                <div class="stat-card-change" id="changeSuratKeluar">+0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-send-fill"></i>
              </div>
            </div>

            <div
              class="stat-card maroon"
              onclick="navigateTo('arsip.html')"
              title="Klik untuk melihat Arsip"
            >
              <div class="stat-card-content">
                <div class="stat-card-title">Arsip</div>
                <div class="stat-card-value" id="statArsip">0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-folder-fill"></i>
              </div>
            </div>

            <div
              class="stat-card light-blue"
              onclick="navigateTo('nota-dinas.html')"
              title="Klik untuk melihat Nota Dinas"
            >
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Nota Dinas</div>
                <div class="stat-card-value" id="statNotaDinas">0</div>
                <div class="stat-card-change" id="changeNotaDinas">+0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-file-text-fill"></i>
              </div>
            </div>
          </div>

          <!-- Dashboard Summary -->
          <div class="dashboard-summary">
            <div class="summary-header">
              <h2 class="summary-title">Dashboard Summary Activity Document</h2>
            </div>
            <div class="summary-content">
              <div class="progress-section">
                <div class="progress-box blue-bg">
                  <div class="progress-label blue">Surat Sudah Diaksi</div>
                  <div class="progress-value" id="progressSudahDiaksi">0%</div>
                  <div
                    style="
                      position: absolute;
                      bottom: 0;
                      left: 0;
                      height: 4px;
                      background: rgba(37, 99, 235, 0.3);
                      width: 100%;
                    "
                  >
                    <div
                      id="progressBarSudah"
                      style="
                        height: 100%;
                        background: #2563eb;
                        width: 0%;
                        transition: width 0.5s;
                      "
                    ></div>
                  </div>
                </div>
                <div class="progress-box red-bg">
                  <div class="progress-label red">Surat Belum Diaksi</div>
                  <div class="progress-value red" id="progressBelumDiaksi">
                    0%
                  </div>
                  <div
                    style="
                      position: absolute;
                      bottom: 0;
                      left: 0;
                      height: 4px;
                      background: rgba(220, 38, 38, 0.3);
                      width: 100%;
                    "
                  >
                    <div
                      id="progressBarBelum"
                      style="
                        height: 100%;
                        background: #dc2626;
                        width: 0%;
                        transition: width 0.5s;
                      "
                    ></div>
                  </div>
                </div>
              </div>

              <!-- ‚úÖ IMPROVED: Compact Circular Cards -->
              <div class="circular-cards">
                <div class="circular-card blue">
                  <div class="circular-card-title">Surat Masuk</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text" id="percentSuratMasuk">
                      75%
                    </div>
                  </div>
                </div>
                <div class="circular-card green">
                  <div class="circular-card-title">Surat Keluar</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text" id="percentSuratKeluar">
                      25%
                    </div>
                  </div>
                </div>
                <div class="circular-card yellow">
                  <div class="circular-card-title">Surat Nota Dinas</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text" id="percentNotaDinas">
                      50%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Monitoring Surat Table -->
          <div class="monitoring-section">
            <div class="monitoring-header">
              <h3 class="monitoring-title">Monitoring Surat</h3>
              <select class="month-selector" id="monthSelector">
                <option value="all">Semua Bulan</option>
                <option value="0">Januari</option>
                <option value="1">Februari</option>
                <option value="2">Maret</option>
                <option value="3">April</option>
                <option value="4">Mei</option>
                <option value="5">Juni</option>
                <option value="6">Juli</option>
                <option value="7">Agustus</option>
                <option value="8">September</option>
                <option value="9">Oktober</option>
                <option value="10">November</option>
                <option value="11">Desember</option>
              </select>
            </div>
            <table class="monitoring-table">
              <thead>
                <tr>
                  <th>Dari</th>
                  <th>Nomor Agenda Surat</th>
                  <th>Nomor Surat</th>
                  <th>Kepada</th>
                  <th>Perihal</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="monitoringTableBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px">
                    Loading data...
                  </td>
                </tr>
              </tbody>
            </table>
            <a href="monitoring.html" class="more-link"
              >Lihat Selengkapnya...</a
            >
          </div>

          <!-- Footer -->
          <div id="footer-placeholder"></div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/database.js"></script>

    <script>
      console.log(
        "üìÑ Dashboard Admin page loaded v6.0 - COMPACT CIRCULAR PROGRESS"
      );

      let unsubscribeMasuk = null;
      let unsubscribeKeluar = null;
      let unsubscribeNotaDinas = null;

      let previousCounts = {
        masuk: 0,
        keluar: 0,
        notaDinas: 0,
      };

      // ========================================
      // NAVIGATION FUNCTION
      // ========================================
      window.navigateTo = function (page) {
        console.log("üîó Navigating to:", page);
        window.location.href = page;
      };

      // ========================================
      // INITIALIZE DASHBOARD
      // ========================================
      function initDashboard() {
        console.log("üöÄ Initializing realtime dashboard...");

        checkUserRole(["admin"])
          .then((userData) => {
            console.log("‚úÖ Admin access granted:", userData);

            const userNameDisplay = document.getElementById("userNameDisplay");
            if (userNameDisplay) {
              userNameDisplay.textContent = userData.nama || userData.email;
            }

            if (window.loadIncludes) {
              window.loadIncludes();
            }

            setTimeout(() => {
              ensureSidebarDropdownWorks();
            }, 500);

            loadDashboardStatsRealtime();
            setupMonthSelector();
          })
          .catch((error) => {
            console.error("‚ùå Access denied:", error);
          });
      }

      // ========================================
      // FIX SIDEBAR DROPDOWN
      // ========================================
      function ensureSidebarDropdownWorks() {
        console.log("üîß Ensuring sidebar dropdown functionality...");

        const dropdownToggles = document.querySelectorAll(
          ".menu-dropdown-toggle"
        );

        dropdownToggles.forEach((toggle) => {
          const newToggle = toggle.cloneNode(true);
          toggle.parentNode.replaceChild(newToggle, toggle);

          newToggle.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();

            const menuItem = this.closest(".menu-dropdown");
            const isOpen = menuItem.classList.contains("open");

            document.querySelectorAll(".menu-dropdown").forEach((item) => {
              if (item !== menuItem) {
                item.classList.remove("open");
              }
            });

            menuItem.classList.toggle("open");
          });
        });

        console.log("‚úÖ Sidebar dropdown functionality ensured");
      }

      // ========================================
      // SETUP MONTH SELECTOR
      // ========================================
      function setupMonthSelector() {
        const monthSelector = document.getElementById("monthSelector");
        if (monthSelector) {
          const currentMonth = new Date().getMonth();
          monthSelector.value = currentMonth;

          monthSelector.addEventListener("change", () => {
            loadMonitoringTable();
          });
        }
      }

      // ========================================
      // ANIMATE VALUE CHANGE
      // ========================================
      function animateValueChange(element, newValue) {
        element.classList.add("updating");
        element.textContent = newValue;
        setTimeout(() => {
          element.classList.remove("updating");
        }, 500);
      }

      // ========================================
      // CALCULATE PERCENTAGES
      // ========================================
      function calculatePercentages(masukCount, keluarCount, notaDinasCount) {
        const total = masukCount + keluarCount + notaDinasCount;

        if (total === 0) {
          return {
            masuk: 0,
            keluar: 0,
            notaDinas: 0,
          };
        }

        return {
          masuk: Math.round((masukCount / total) * 100),
          keluar: Math.round((keluarCount / total) * 100),
          notaDinas: Math.round((notaDinasCount / total) * 100),
        };
      }

      // ========================================
      // UPDATE PROGRESS BARS
      // ========================================
      function updateProgressBars(masukCount, keluarCount, notaDinasCount) {
        Promise.all([
          db
            .collection("surat_masuk")
            .where("isDeleted", "==", false)
            .where("status", "in", ["Selesai", "Proses"])
            .get(),
          db.collection("surat_keluar").where("isDeleted", "==", false).get(),
          db
            .collection("nota_dinas")
            .where("isDeleted", "==", false)
            .where("status", "in", ["Selesai", "Proses"])
            .get(),
        ]).then((results) => {
          const sudahDiaksi =
            results[0].size + results[1].size + results[2].size;
          const total = masukCount + keluarCount + notaDinasCount;
          const belumDiaksi = total - sudahDiaksi;

          const percentSudah =
            total > 0 ? Math.round((sudahDiaksi / total) * 100) : 0;
          const percentBelum =
            total > 0 ? Math.round((belumDiaksi / total) * 100) : 0;

          const elemSudah = document.getElementById("progressSudahDiaksi");
          const elemBelum = document.getElementById("progressBelumDiaksi");
          const barSudah = document.getElementById("progressBarSudah");
          const barBelum = document.getElementById("progressBarBelum");

          if (elemSudah) {
            animateValueChange(elemSudah, percentSudah + "%");
            elemSudah.parentElement.classList.add("updating");
            setTimeout(() => {
              elemSudah.parentElement.classList.remove("updating");
            }, 500);
          }

          if (elemBelum) {
            animateValueChange(elemBelum, percentBelum + "%");
            elemBelum.parentElement.classList.add("updating");
            setTimeout(() => {
              elemBelum.parentElement.classList.remove("updating");
            }, 500);
          }

          if (barSudah) {
            barSudah.style.width = percentSudah + "%";
          }
          if (barBelum) {
            barBelum.style.width = percentBelum + "%";
          }

          console.log(
            `üìä Progress: ${percentSudah}% sudah diaksi, ${percentBelum}% belum diaksi`
          );
        });
      }

      // ========================================
      // ‚úÖ IMPROVED: UPDATE CIRCULAR PROGRESS (COMPACT)
      // ========================================
      function updateCircularProgress(masukCount, keluarCount, notaDinasCount) {
        const percentages = calculatePercentages(
          masukCount,
          keluarCount,
          notaDinasCount
        );

        // Circumference = 2 * PI * radius = 2 * 3.14159 * 54 = 339.3
        const circumference = 339.3;

        // Update Surat Masuk
        const percentMasukEl = document.getElementById("percentSuratMasuk");
        const circleMasuk = document.getElementById("circleSuratMasuk");
        if (percentMasukEl && circleMasuk) {
          animateValueChange(percentMasukEl, percentages.masuk + "%");
          const offset =
            circumference - (percentages.masuk / 100) * circumference;
          circleMasuk.style.strokeDashoffset = offset;
        }

        // Update Surat Keluar
        const percentKeluarEl = document.getElementById("percentSuratKeluar");
        const circleKeluar = document.getElementById("circleSuratKeluar");
        if (percentKeluarEl && circleKeluar) {
          animateValueChange(percentKeluarEl, percentages.keluar + "%");
          const offset =
            circumference - (percentages.keluar / 100) * circumference;
          circleKeluar.style.strokeDashoffset = offset;
        }

        // Update Nota Dinas
        const percentNotaDinasEl = document.getElementById("percentNotaDinas");
        const circleNotaDinas = document.getElementById("circleNotaDinas");
        if (percentNotaDinasEl && circleNotaDinas) {
          animateValueChange(percentNotaDinasEl, percentages.notaDinas + "%");
          const offset =
            circumference - (percentages.notaDinas / 100) * circumference;
          circleNotaDinas.style.strokeDashoffset = offset;
        }

        console.log(
          `üéØ Circular Progress: Masuk ${percentages.masuk}%, Keluar ${percentages.keluar}%, Nota Dinas ${percentages.notaDinas}%`
        );
      }

      // ========================================
      // LOAD DASHBOARD STATISTICS - REAL-TIME
      // ========================================
      function loadDashboardStatsRealtime() {
        console.log("üìä Setting up real-time listeners...");

        let masukCount = 0;
        let keluarCount = 0;
        let notaDinasCount = 0;

        // Surat Masuk Listener
        if (unsubscribeMasuk) unsubscribeMasuk();
        unsubscribeMasuk = db
          .collection("surat_masuk")
          .where("isDeleted", "==", false)
          .onSnapshot(
            (snapshot) => {
              const count = snapshot.size;
              masukCount = count;

              const element = document.getElementById("statSuratMasuk");
              if (element) {
                animateValueChange(element, count);
              }

              const change = count - previousCounts.masuk;
              const changeElement = document.getElementById("changeSuratMasuk");
              if (changeElement && previousCounts.masuk > 0) {
                changeElement.textContent = change >= 0 ? `+${change}` : change;
                changeElement.style.color = change >= 0 ? "#10b981" : "#ef4444";
              }
              previousCounts.masuk = count;

              updateCircularProgress(masukCount, keluarCount, notaDinasCount);
              updateProgressBars(masukCount, keluarCount, notaDinasCount);
              loadMonitoringTable();
            },
            (error) => {
              console.error("‚ùå Error in Surat Masuk listener:", error);
            }
          );

        // Surat Keluar Listener
        if (unsubscribeKeluar) unsubscribeKeluar();
        unsubscribeKeluar = db
          .collection("surat_keluar")
          .where("isDeleted", "==", false)
          .onSnapshot(
            (snapshot) => {
              const count = snapshot.size;
              keluarCount = count;

              const element = document.getElementById("statSuratKeluar");
              if (element) {
                animateValueChange(element, count);
              }

              const change = count - previousCounts.keluar;
              const changeElement =
                document.getElementById("changeSuratKeluar");
              if (changeElement && previousCounts.keluar > 0) {
                changeElement.textContent = change >= 0 ? `+${change}` : change;
                changeElement.style.color = change >= 0 ? "#10b981" : "#ef4444";
              }
              previousCounts.keluar = count;

              updateCircularProgress(masukCount, keluarCount, notaDinasCount);
              updateProgressBars(masukCount, keluarCount, notaDinasCount);
              loadMonitoringTable();
            },
            (error) => {
              console.error("‚ùå Error in Surat Keluar listener:", error);
            }
          );

        // Nota Dinas Listener
        if (unsubscribeNotaDinas) unsubscribeNotaDinas();
        unsubscribeNotaDinas = db
          .collection("nota_dinas")
          .where("isDeleted", "==", false)
          .onSnapshot(
            (snapshot) => {
              const count = snapshot.size;
              notaDinasCount = count;

              const element = document.getElementById("statNotaDinas");
              if (element) {
                animateValueChange(element, count);
              }

              const change = count - previousCounts.notaDinas;
              const changeElement = document.getElementById("changeNotaDinas");
              if (changeElement && previousCounts.notaDinas > 0) {
                changeElement.textContent = change >= 0 ? `+${change}` : change;
                changeElement.style.color = change >= 0 ? "#10b981" : "#ef4444";
              }
              previousCounts.notaDinas = count;

              updateCircularProgress(masukCount, keluarCount, notaDinasCount);
              updateProgressBars(masukCount, keluarCount, notaDinasCount);
              loadMonitoringTable();
            },
            (error) => {
              console.error("‚ùå Error in Nota Dinas listener:", error);
            }
          );

        loadArsipCountRealtime();
      }

      // ========================================
      // LOAD ARSIP COUNT - REAL-TIME
      // ========================================
      function loadArsipCountRealtime() {
        let arsipCount = 0;

        db.collection("surat_masuk")
          .where("isDeleted", "==", true)
          .onSnapshot((snapshot) => {
            arsipCount = snapshot.size;
            updateArsipDisplay();
          });

        db.collection("surat_keluar")
          .where("isDeleted", "==", true)
          .onSnapshot((snapshot) => {
            arsipCount += snapshot.size;
            updateArsipDisplay();
          });

        db.collection("nota_dinas")
          .where("isDeleted", "==", true)
          .onSnapshot((snapshot) => {
            arsipCount += snapshot.size;
            updateArsipDisplay();
          });

        function updateArsipDisplay() {
          const element = document.getElementById("statArsip");
          if (element) {
            animateValueChange(element, arsipCount);
          }
        }
      }

      // ========================================
      // LOAD MONITORING TABLE
      // ========================================
      function loadMonitoringTable() {
        const tbody = document.getElementById("monitoringTableBody");
        const monthSelector = document.getElementById("monthSelector");

        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Loading...</td></tr>';

        const selectedMonth = monthSelector ? monthSelector.value : "all";

        Promise.all([
          db.collection("surat_masuk").where("isDeleted", "==", false).get(),
          db.collection("surat_keluar").where("isDeleted", "==", false).get(),
          db.collection("nota_dinas").where("isDeleted", "==", false).get(),
        ])
          .then((results) => {
            const allSurat = [];

            results[0].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "masuk",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            results[1].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "keluar",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            results[2].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "nota-dinas",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            // Filter by month if selected
            let filteredSurat = allSurat;
            if (selectedMonth !== "all") {
              const monthNum = parseInt(selectedMonth);
              filteredSurat = allSurat.filter((surat) => {
                return surat._createdAt.getMonth() === monthNum;
              });
            }

            // Sort by date (newest first)
            filteredSurat.sort((a, b) => b._createdAt - a._createdAt);

            // Take only 5 latest
            const latest5 = filteredSurat.slice(0, 5);

            if (latest5.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">Belum ada data surat</td></tr>';
              return;
            }

            tbody.innerHTML = latest5
              .map((surat) => {
                const dari = surat.dari || surat.namaPengirim || "N/A";
                const noSurat = surat.noSurat || surat.noNaskah || "N/A";
                const kepada = surat.kepada || surat.tujuan || "N/A";
                const perihal = surat.perihal || "N/A";
                const status = surat.status || "Pending";
                const statusClass = getStatusClass(status);

                return `
                <tr>
                  <td>
                    <span class="organization-icon">
                      <i class="bi bi-person-circle"></i>
                    </span>
                    ${dari}
                  </td>
                  <td>${surat.noAgenda || "-"}</td>
                  <td>${noSurat}</td>
                  <td>${kepada}</td>
                  <td>${perihal}</td>
                  <td>
                    <span class="status-badge ${statusClass}">
                      ${status}
                    </span>
                  </td>
                </tr>
              `;
              })
              .join("");

            console.log("‚úÖ Monitoring table updated");
          })
          .catch((error) => {
            console.error("‚ùå Error loading monitoring:", error);
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc2626;">Error loading data</td></tr>';
          });
      }

      function getStatusClass(status) {
        const statusMap = {
          Selesai: "selesai",
          Proses: "proses",
          Pending: "pending",
          Ditolak: "ditolak",
          Disetujui: "disetujui",
        };
        return statusMap[status] || "pending";
      }

      // ========================================
      // CLEANUP LISTENERS
      // ========================================
      window.addEventListener("beforeunload", () => {
        console.log("üßπ Cleaning up listeners...");
        if (unsubscribeMasuk) unsubscribeMasuk();
        if (unsubscribeKeluar) unsubscribeKeluar();
        if (unsubscribeNotaDinas) unsubscribeNotaDinas();
      });

      // ========================================
      // START INITIALIZATION
      // ========================================
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initDashboard);
      } else {
        initDashboard();
      }

      console.log("‚úÖ Dashboard v5.0 - SINGLE LARGE CIRCULAR PROGRESS RING");
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Dashboard - D-Takah Kemenhan</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
  </head>
  <body>
    <div class="dashboard-overview">
      <!-- Sidebar placeholder -->
      <div id="sidebar-placeholder"></div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <div class="content-header">
          <div class="header-left">
            <i class="bi bi-list"></i>
            <i class="bi bi-star"></i>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="#">Dashboards</a></li>
                <li class="breadcrumb-item active">Overview</li>
              </ol>
            </nav>
          </div>
          <div class="header-right">
            <div class="search-box">
              <input type="text" placeholder="Search" />
              <i class="bi bi-search"></i>
            </div>
            <button class="header-btn">
              <i class="bi bi-sun-fill"></i>
            </button>
            <button class="header-btn notification">
              <i class="bi bi-bell-fill"></i>
              <span class="notification-badge">4</span>
            </button>
            <div class="user-info" id="userInfoHeader">
              <i class="bi bi-person-circle"></i>
              <span id="userNameDisplay">Loading...</span>
            </div>
          </div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
          <!-- Stats Cards -->
          <div class="stats-cards">
            <div class="stat-card blue">
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Masuk</div>
                <div class="stat-card-value" id="statSuratMasuk">0</div>
                <div class="stat-card-change">+11</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-envelope-fill"></i>
              </div>
            </div>
            <div class="stat-card red">
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Keluar</div>
                <div class="stat-card-value" id="statSuratKeluar">0</div>
                <div class="stat-card-change">+3</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-send-fill"></i>
              </div>
            </div>
            <div class="stat-card maroon">
              <div class="stat-card-content">
                <div class="stat-card-title">Arsip</div>
                <div class="stat-card-value" id="statArsip">0</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-folder-fill"></i>
              </div>
            </div>
            <div class="stat-card light-blue">
              <div class="stat-card-content">
                <div class="stat-card-title">Surat Nota Dinas</div>
                <div class="stat-card-value" id="statNotaDinas">0</div>
                <div class="stat-card-change">+5</div>
              </div>
              <div class="stat-card-icon">
                <i class="bi bi-file-text-fill"></i>
              </div>
            </div>
          </div>

          <!-- Dashboard Summary -->
          <div class="dashboard-summary">
            <div class="summary-header">
              <h2 class="summary-title">Dashboard Summary Activity Document</h2>
            </div>
            <div class="summary-content">
              <div class="progress-section">
                <div class="progress-box blue-bg">
                  <div class="progress-label blue">Surat Sudah Diaksi</div>
                  <div class="progress-value">47%</div>
                </div>
                <div class="progress-box red-bg">
                  <div class="progress-label red">Surat Belum Diaksi</div>
                  <div class="progress-value red">53%</div>
                </div>
              </div>

              <div class="circular-cards">
                <div class="circular-card blue">
                  <div class="circular-card-title">Surat Masuk</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text">75%</div>
                  </div>
                </div>
                <div class="circular-card green">
                  <div class="circular-card-title">Surat Keluar</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text">25%</div>
                  </div>
                </div>
                <div class="circular-card yellow">
                  <div class="circular-card-title">Surat Nota Dinas</div>
                  <div class="circular-progress">
                    <div class="circular-progress-text">50%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Monitoring Surat Table -->
          <div class="monitoring-section">
            <div class="monitoring-header">
              <h3 class="monitoring-title">Monitoring Surat</h3>
              <select class="month-selector">
                <option>Januari</option>
                <option>Februari</option>
                <option>Maret</option>
                <option>April</option>
                <option>Mei</option>
                <option>Juni</option>
                <option>Juli</option>
                <option>Agustus</option>
                <option>September</option>
                <option>Oktober</option>
                <option>November</option>
                <option>Desember</option>
              </select>
            </div>
            <table class="monitoring-table">
              <thead>
                <tr>
                  <th>Dari</th>
                  <th>Nomor Agenda Surat</th>
                  <th>Nomor Surat</th>
                  <th>Kepada</th>
                  <th>Perihal</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="monitoringTableBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px">
                    Loading data...
                  </td>
                </tr>
              </tbody>
            </table>
            <a href="monitoring.html" class="more-link"
              >Lihat Selengkapnya...</a
            >
          </div>

          <!-- Footer -->
          <div id="footer-placeholder"></div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="assets/js/firebase-config.js"></script>

    <!-- Auth Functions -->
    <script src="assets/js/auth.js"></script>

    <!-- Main Functions -->
    <script src="assets/js/main.js"></script>

    <!-- Database Functions -->
    <script src="assets/js/database.js"></script>

    <!-- Page Initialization -->
    <script>
      console.log("üìÑ Dashboard Admin page loaded v2.0");

      let unsubscribeMasuk = null;
      let unsubscribeKeluar = null;
      let unsubscribeNotaDinas = null;

      // ========================================
      // INITIALIZE DASHBOARD
      // ========================================
      function initDashboard() {
        console.log("üöÄ Initializing dashboard...");

        // Check authentication and role
        checkUserRole(["admin"])
          .then((userData) => {
            console.log("‚úÖ Admin access granted:", userData);

            // Display user info
            const userNameDisplay = document.getElementById("userNameDisplay");
            if (userNameDisplay) {
              userNameDisplay.textContent = userData.nama || userData.email;
            }

            // Load includes (sidebar, footer)
            if (window.loadIncludes) {
              window.loadIncludes();
            }

            // Load dashboard data with real-time listeners
            loadDashboardStatsRealtime();
          })
          .catch((error) => {
            console.error("‚ùå Access denied:", error);
            // User will be redirected by checkUserRole
          });
      }

      // ========================================
      // LOAD DASHBOARD STATISTICS - REAL-TIME
      // ========================================
      function loadDashboardStatsRealtime() {
        console.log("üìä Setting up real-time listeners...");

        // Surat Masuk Listener
        if (unsubscribeMasuk) unsubscribeMasuk();
        unsubscribeMasuk = db
          .collection("surat_masuk")
          .where("isDeleted", "==", false)
          .onSnapshot((snapshot) => {
            const count = snapshot.size;
            document.getElementById("statSuratMasuk").textContent = count;
            console.log("üì® Surat Masuk:", count);
            loadMonitoringTable();
          });

        // Surat Keluar Listener
        if (unsubscribeKeluar) unsubscribeKeluar();
        unsubscribeKeluar = db
          .collection("surat_keluar")
          .where("isDeleted", "==", false)
          .onSnapshot((snapshot) => {
            const count = snapshot.size;
            document.getElementById("statSuratKeluar").textContent = count;
            console.log("üì§ Surat Keluar:", count);
            loadMonitoringTable();
          });

        // Nota Dinas Listener
        if (unsubscribeNotaDinas) unsubscribeNotaDinas();
        unsubscribeNotaDinas = db
          .collection("nota_dinas")
          .where("isDeleted", "==", false)
          .onSnapshot((snapshot) => {
            const count = snapshot.size;
            document.getElementById("statNotaDinas").textContent = count;
            console.log("üìù Nota Dinas:", count);
            loadMonitoringTable();
          });

        // Load Arsip (deleted documents)
        loadArsipCount();
      }

      // ========================================
      // LOAD ARSIP COUNT
      // ========================================
      function loadArsipCount() {
        Promise.all([
          db.collection("surat_masuk").where("isDeleted", "==", true).get(),
          db.collection("surat_keluar").where("isDeleted", "==", true).get(),
          db.collection("nota_dinas").where("isDeleted", "==", true).get(),
        ])
          .then((results) => {
            const totalArsip =
              results[0].size + results[1].size + results[2].size;
            document.getElementById("statArsip").textContent = totalArsip;
            console.log("üóÑÔ∏è Arsip:", totalArsip);
          })
          .catch((error) => {
            console.error("‚ùå Error loading arsip:", error);
          });
      }

      // ========================================
      // LOAD MONITORING TABLE
      // ========================================
      function loadMonitoringTable() {
        const tbody = document.getElementById("monitoringTableBody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Loading...</td></tr>';

        Promise.all([
          db.collection("surat_masuk").where("isDeleted", "==", false).get(),
          db.collection("surat_keluar").where("isDeleted", "==", false).get(),
          db.collection("nota_dinas").where("isDeleted", "==", false).get(),
        ])
          .then((results) => {
            const allSurat = [];

            results[0].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "masuk",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            results[1].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "keluar",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            results[2].forEach((doc) => {
              const data = doc.data();
              allSurat.push({
                ...data,
                id: doc.id,
                type: "nota-dinas",
                _createdAt: data.createdAt
                  ? data.createdAt.toDate()
                  : new Date(0),
              });
            });

            // Sort by date (newest first)
            allSurat.sort((a, b) => b._createdAt - a._createdAt);

            // Take only 5 latest
            const latest5 = allSurat.slice(0, 5);

            if (latest5.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">Belum ada data surat</td></tr>';
              return;
            }

            tbody.innerHTML = latest5
              .map((surat) => {
                const dari = surat.dari || surat.namaPengirim || "N/A";
                const noSurat = surat.noSurat || surat.noNaskah || "N/A";
                const kepada = surat.kepada || surat.tujuan || "N/A";
                const perihal = surat.perihal || "N/A";
                const status = surat.status || "Pending";
                const statusClass = getStatusClass(status);

                return `
                <tr>
                  <td>
                    <span class="organization-icon">
                      <i class="bi bi-person-circle"></i>
                    </span>
                    ${dari}
                  </td>
                  <td>${surat.noAgenda || "-"}</td>
                  <td>${noSurat}</td>
                  <td>${kepada}</td>
                  <td>${perihal}</td>
                  <td>
                    <span class="status-badge ${statusClass}">
                      ${status}
                    </span>
                  </td>
                </tr>
              `;
              })
              .join("");

            console.log("‚úÖ Monitoring table updated");
          })
          .catch((error) => {
            console.error("‚ùå Error loading monitoring:", error);
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc2626;">Error loading data</td></tr>';
          });
      }

      function getStatusClass(status) {
        const statusMap = {
          Selesai: "selesai",
          Proses: "proses",
          Pending: "pending",
          Ditolak: "ditolak",
          Disetujui: "disetujui",
        };
        return statusMap[status] || "pending";
      }

      // ========================================
      // CLEANUP LISTENERS
      // ========================================
      window.addEventListener("beforeunload", () => {
        if (unsubscribeMasuk) unsubscribeMasuk();
        if (unsubscribeKeluar) unsubscribeKeluar();
        if (unsubscribeNotaDinas) unsubscribeNotaDinas();
      });

      // ========================================
      // START INITIALIZATION
      // ========================================
      // Wait for auth.js to load
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initDashboard);
      } else {
        initDashboard();
      }

      console.log("‚úÖ Dashboard initialization script loaded v2.0");
    </script>
  </body>
</html>

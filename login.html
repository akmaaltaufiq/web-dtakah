<!DOCTYPE html>
<html lang="id">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Login - D-Takah Kemenhan</title>
    <link rel="stylesheet" href="assets/css/login.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
      <div class="loading-content">
        <div class="loading-logo">
          <img src="assets/img/logo_kemhan_ri.png" alt="Logo" />
        </div>
        <div class="loading-spinner">
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
        </div>
        <div class="loading-text">
          Sedang Memproses<span class="loading-dots"></span>
        </div>
        <div class="loading-subtext">Mohon tunggu sebentar</div>
      </div>
    </div>

    <!-- Login Page -->
    <div class="login-page">
      <div class="login-container">
        <!-- Logo -->
        <div class="logo-container">
          <img src="assets/img/logo_kemhan_ri.png" alt="Logo Kemhan RI" />
        </div>

        <!-- Login Card -->
        <div class="login-card">
          <div class="login-header">
            <h1>Selamat Datang</h1>
            <p>Platform Kolaborasi dan Smart Office</p>
          </div>

          <!-- LOGIN FORM -->
          <form id="loginForm">
            <!-- Email Field -->
            <div class="form-group">
              <label class="form-label">Email</label>
              <div class="input-wrapper">
                <div class="input-icon">
                  <i class="bi bi-envelope"></i>
                </div>
                <input
                  type="email"
                  id="email"
                  class="form-input"
                  placeholder="masukkan email"
                  autocomplete="email"
                  required
                />
              </div>
            </div>

            <!-- Password Field -->
            <div class="form-group">
              <label class="form-label">Password</label>
              <div class="input-wrapper">
                <div class="input-icon">
                  <i class="bi bi-lock"></i>
                </div>
                <input
                  type="password"
                  id="password"
                  class="form-input"
                  placeholder="masukkan password anda"
                  autocomplete="current-password"
                  required
                />
                <button
                  type="button"
                  class="toggle-password"
                  id="togglePassword"
                  aria-label="Toggle password visibility"
                >
                  <i class="bi bi-eye-slash"></i>
                </button>
              </div>
            </div>

            <!-- Options -->
            <div class="form-options">
              <div class="remember-me">
                <input type="checkbox" id="remember" />
                <label for="remember">Ingat saya</label>
              </div>
              <a href="#" class="forgot-password" id="forgotPasswordLink"
                >Lupa Password?</a
              >
            </div>

            <!-- Login Button -->
            <button type="submit" class="login-button" id="loginBtn">
              <i class="bi bi-box-arrow-in-right"></i>
              Masuk
            </button>
          </form>

          <!-- Info Text -->
          <div style="margin-top: 20px; text-align: center">
            <p style="color: #6b7280; font-size: 13px">
              Hubungi administrator untuk pembuatan akun baru
            </p>
          </div>
        </div>

        <!-- Footer -->
        <div class="login-footer">
          <p>Tata Naskah Digital</p>
          <p>Kementerian Pertahanan Republik Indonesia</p>
          <p>Pusat Panggilan: 0812-8595-1569</p>
          <p>Aplikasi ini didukung oleh Balai Sertifikasi Elektronik</p>
          <img src="assets/img/bse.png" alt="BSE Logo" />
        </div>
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- SweetAlert2 for better UI -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase Config -->
    <script src="assets/js/firebase-config.js"></script>

    <!-- Auth Functions -->
    <script src="assets/js/auth.js"></script>

    <!-- Login Page Script -->
    <script>
      console.log("üìÑ Login page loaded v2.0 - Final");

      // ============================================
      // FORCE CLEAR OLD SESSIONS ON PAGE LOAD
      // ============================================
      (function initLoginPage() {
        console.log("üßπ Initializing login page - clearing old sessions...");

        const urlParams = new URLSearchParams(window.location.search);
        const isFromLogout = urlParams.get("logout") === "true";

        // ALWAYS clear storage on login page for clean state
        sessionStorage.clear();
        localStorage.clear();

        // Force Firebase logout if auth is available
        if (window.auth) {
          auth
            .signOut()
            .then(() => {
              console.log("‚úÖ Firebase auth cleared");
            })
            .catch((err) => {
              console.warn(
                "‚ö†Ô∏è Firebase signOut error (might be already logged out):",
                err
              );
            });
        }

        // Clean URL if coming from logout
        if (isFromLogout) {
          window.history.replaceState({}, document.title, "login.html");
          console.log("üîÑ URL cleaned");
        }

        console.log("‚úÖ Login page ready - clean state initialized");
      })();

      // ============================================
      // LOADING SCREEN FUNCTIONS
      // ============================================
      window.showLoading = function () {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) {
          loadingScreen.classList.add("show");
        }
      };

      window.hideLoading = function () {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) {
          loadingScreen.classList.remove("show");
        }
      };

      // ============================================
      // PASSWORD TOGGLE VISIBILITY
      // ============================================
      const togglePassword = document.getElementById("togglePassword");
      const passwordInput = document.getElementById("password");

      if (togglePassword && passwordInput) {
        togglePassword.addEventListener("click", function () {
          const type = passwordInput.type === "password" ? "text" : "password";
          passwordInput.type = type;

          const icon = this.querySelector("i");
          icon.classList.toggle("bi-eye-slash");
          icon.classList.toggle("bi-eye");
        });
      }

      // ============================================
      // REMEMBER ME FUNCTIONALITY
      // ============================================
      function loadRememberedCredentials() {
        const rememberedEmail = localStorage.getItem("rememberedEmail");
        const rememberMe = localStorage.getItem("rememberMe") === "true";

        if (rememberMe && rememberedEmail) {
          document.getElementById("email").value = rememberedEmail;
          document.getElementById("remember").checked = true;
          console.log("‚úÖ Loaded remembered email:", rememberedEmail);
        }
      }

      function saveRememberMe(email, remember) {
        if (remember) {
          localStorage.setItem("rememberedEmail", email);
          localStorage.setItem("rememberMe", "true");
          console.log("‚úÖ Email saved for remember me:", email);
        } else {
          localStorage.removeItem("rememberedEmail");
          localStorage.removeItem("rememberMe");
          console.log("üóëÔ∏è Remember me data cleared");
        }
      }

      // Load remembered credentials on page load
      loadRememberedCredentials();

      // ============================================
      // FORGOT PASSWORD FUNCTIONALITY - WITH SWEETALERT2
      // ============================================
      const forgotPasswordLink = document.getElementById("forgotPasswordLink");

      if (forgotPasswordLink) {
        forgotPasswordLink.addEventListener("click", function (e) {
          e.preventDefault();

          console.log("üîë Forgot password clicked");

          // Get email from input field if available
          const currentEmail = document.getElementById("email").value.trim();

          // Show SweetAlert2 input dialog
          Swal.fire({
            title: "Lupa Password?",
            html: `
              <p style="margin-bottom: 15px; color: #6b7280;">
                Masukkan email akun Anda.<br>
                Link reset password akan dikirim ke email tersebut.
              </p>
            `,
            input: "email",
            inputValue: currentEmail,
            inputPlaceholder: "masukkan email anda",
            inputAttributes: {
              autocomplete: "email",
            },
            showCancelButton: true,
            confirmButtonText: "Kirim Email Reset",
            cancelButtonText: "Batal",
            confirmButtonColor: "#8b0000",
            cancelButtonColor: "#6b7280",
            showLoaderOnConfirm: true,
            inputValidator: (value) => {
              if (!value) {
                return "Email wajib diisi!";
              }
              // Validasi format email
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(value)) {
                return "Format email tidak valid!";
              }
            },
            preConfirm: (email) => {
              console.log("üìß Sending password reset to:", email);

              // Send password reset email via Firebase
              return auth
                .sendPasswordResetEmail(email)
                .then(() => {
                  return { success: true, email: email };
                })
                .catch((error) => {
                  console.error("‚ùå Password reset error:", error);

                  let errorMessage = "Gagal mengirim email reset password.";

                  if (error.code === "auth/user-not-found") {
                    errorMessage =
                      "Email tidak terdaftar! Silakan hubungi administrator.";
                  } else if (error.code === "auth/invalid-email") {
                    errorMessage = "Format email tidak valid!";
                  } else if (error.code === "auth/too-many-requests") {
                    errorMessage =
                      "Terlalu banyak percobaan! Silakan coba lagi nanti.";
                  } else {
                    errorMessage = error.message;
                  }

                  Swal.showValidationMessage(errorMessage);
                });
            },
            allowOutsideClick: () => !Swal.isLoading(),
          }).then((result) => {
            if (result.isConfirmed && result.value.success) {
              // Success message
              Swal.fire({
                icon: "success",
                title: "Email Terkirim!",
                html: `
                  <p style="margin-bottom: 10px;">
                    Link reset password telah dikirim ke:
                  </p>
                  <p style="font-weight: 600; color: #8b0000; margin-bottom: 15px;">
                    ${result.value.email}
                  </p>
                  <div style="text-align: left; background: #f3f4f6; padding: 15px; border-radius: 8px; font-size: 14px;">
                    <p style="margin: 0 0 8px 0; font-weight: 600;">Jika tidak menerima email:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                      <li>Periksa folder <strong>Spam/Junk</strong></li>
                      <li>Tunggu beberapa menit</li>
                      <li>Pastikan email sudah terdaftar</li>
                    </ul>
                  </div>
                `,
                confirmButtonText: "OK, Mengerti",
                confirmButtonColor: "#10b981",
              });

              console.log("‚úÖ Password reset email sent");
            }
          });
        });

        console.log("‚úÖ Forgot password handler attached");
      }

      // ============================================
      // LOGIN FORM HANDLER - FIXED & SIMPLIFIED
      // ============================================
      const loginForm = document.getElementById("loginForm");
      const loginBtn = document.getElementById("loginBtn");

      if (loginForm) {
        loginForm.addEventListener("submit", function (e) {
          e.preventDefault();
          e.stopPropagation();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const rememberMe = document.getElementById("remember").checked;

          // Validation
          if (!email || !password) {
            alert("‚ö†Ô∏è Silakan isi email dan password!");
            return;
          }

          if (password.length < 6) {
            alert("‚ö†Ô∏è Password minimal 6 karakter!");
            return;
          }

          console.log("üîê Starting login process for:", email);
          console.log("üìå Remember me:", rememberMe);

          // Save remember me preference
          saveRememberMe(email, rememberMe);

          // Disable button to prevent double submission
          if (loginBtn) {
            loginBtn.disabled = true;
            loginBtn.innerHTML =
              '<i class="bi bi-hourglass-split"></i> Memproses...';
          }

          // Call loginUser function from auth.js
          loginUser(email, password)
            .then((redirectUrl) => {
              console.log("‚úÖ Login successful!");
              console.log("üéØ Redirect URL:", redirectUrl);

              // Add delay to ensure session is saved
              setTimeout(() => {
                console.log("üîÑ Redirecting now...");
                window.location.replace(redirectUrl);
              }, 800);
            })
            .catch((error) => {
              console.error("‚ùå Login failed:", error);

              // Re-enable button on error
              if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML =
                  '<i class="bi bi-box-arrow-in-right"></i> Masuk';
              }

              // Focus back to email for retry
              document.getElementById("email").focus();
            });
        });
      } else {
        console.error("‚ùå Login form not found!");
      }

      // ============================================
      // KEYBOARD SHORTCUTS
      // ============================================
      const emailInput = document.getElementById("email");

      if (emailInput) {
        emailInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            const passwordField = document.getElementById("password");
            if (passwordField) {
              passwordField.focus();
            }
          }
        });
      }

      if (passwordInput) {
        passwordInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            loginForm.dispatchEvent(new Event("submit"));
          }
        });
      }

      // ============================================
      // PREVENT BACK BUTTON AFTER LOGOUT
      // ============================================
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          console.log("üîÑ Page restored from cache - clearing session");
          sessionStorage.clear();
          localStorage.clear();
          window.location.reload();
        }
      });

      // ============================================
      // AUTO-FOCUS ON EMAIL FIELD
      // ============================================
      window.addEventListener("load", function () {
        const emailField = document.getElementById("email");
        if (emailField) {
          emailField.focus();
        }
      });

      console.log("‚úÖ Login page scripts loaded v2.0 - Final");
    </script>
  </body>
</html>

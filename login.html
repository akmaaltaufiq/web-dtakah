<!DOCTYPE html>
<html lang="id">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Login - D-Takah Kemenhan</title>
    <link rel="stylesheet" href="assets/css/login.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
      <div class="loading-content">
        <div class="loading-logo">
          <img src="assets/img/logo_kemhan_ri.png" alt="Logo" />
        </div>
        <div class="loading-spinner">
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
        </div>
        <div class="loading-text">
          Sedang Memproses<span class="loading-dots"></span>
        </div>
        <div class="loading-subtext">Mohon tunggu sebentar</div>
      </div>
    </div>

    <!-- Tambah di bawah logo, sebelum form login -->
    <div style="text-align: center; margin-bottom: 15px">
      <button
        onclick="forceLogout()"
        style="
          background: #dc2626;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        "
      >
        <i class="bi bi-power"></i> Force Logout (Jika Stuck)
      </button>
    </div>

    <script>
      function forceLogout() {
        if (window.auth) {
          auth.signOut().then(() => {
            sessionStorage.clear();
            localStorage.clear();
            alert("‚úÖ Logout berhasil! Silakan login.");
            location.reload();
          });
        } else {
          sessionStorage.clear();
          localStorage.clear();
          alert("‚úÖ Session cleared! Silakan login.");
          location.reload();
        }
      }
    </script>

    <!-- Login Page -->
    <div class="login-page">
      <div class="login-container">
        <!-- Logo -->
        <div class="logo-container">
          <img src="assets/img/logo_kemhan_ri.png" alt="Logo Kemhan RI" />
        </div>

        <!-- Login Card -->
        <div class="login-card">
          <div class="login-header">
            <h1>Selamat Datang</h1>
            <p>Platform Kolaborasi dan Smart Office</p>
          </div>

          <!-- LOGIN FORM -->
          <form id="loginForm">
            <!-- Email Field -->
            <div class="form-group">
              <label class="form-label">Email</label>
              <div class="input-wrapper">
                <div class="input-icon">
                  <i class="bi bi-envelope"></i>
                </div>
                <input
                  type="email"
                  id="email"
                  class="form-input"
                  placeholder="masukkan email"
                  autocomplete="off"
                  required
                />
              </div>
            </div>

            <!-- Password Field -->
            <div class="form-group">
              <label class="form-label">Password</label>
              <div class="input-wrapper">
                <div class="input-icon">
                  <i class="bi bi-lock"></i>
                </div>
                <input
                  type="password"
                  id="password"
                  class="form-input"
                  placeholder="masukkan password anda"
                  autocomplete="off"
                  required
                />
                <button
                  type="button"
                  class="toggle-password"
                  id="togglePassword"
                >
                  <i class="bi bi-eye-slash"></i>
                </button>
              </div>
            </div>

            <!-- Options -->
            <div class="form-options">
              <div class="remember-me">
                <input type="checkbox" id="remember" />
                <label for="remember">Ingat saya</label>
              </div>
              <a href="#" class="forgot-password">Lupa Password?</a>
            </div>

            <!-- Login Button -->
            <button type="submit" class="login-button" id="loginBtn">
              Masuk
            </button>
          </form>

          <!-- DIVIDER -->
          <div
            style="
              margin: 30px 0;
              padding-top: 30px;
              border-top: 2px solid #e5e7eb;
              text-align: center;
            "
          >
            <p
              style="
                color: #9ca3af;
                font-size: 14px;
                font-weight: 500;
                margin-bottom: 20px;
              "
            >
              üß™ Testing Only - Registrasi User Baru
            </p>
          </div>

          <!-- REGISTER FORM (UNTUK TESTING) -->
          <form
            id="registerForm"
            style="background: #f9fafb; padding: 20px; border-radius: 8px"
          >
            <h3
              style="
                margin: 0 0 15px 0;
                font-size: 16px;
                color: #374151;
                font-weight: 600;
              "
            >
              Form Registrasi
            </h3>

            <div class="form-group">
              <label class="form-label">Nama Lengkap *</label>
              <input
                type="text"
                id="nama"
                class="form-input"
                placeholder="Nama lengkap"
                autocomplete="off"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">Email *</label>
              <input
                type="email"
                id="regEmail"
                class="form-input"
                placeholder="Email"
                autocomplete="off"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">Password *</label>
              <input
                type="password"
                id="regPassword"
                class="form-input"
                placeholder="Password (min 6 karakter)"
                autocomplete="off"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">Role *</label>
              <select id="role" class="form-input" required>
                <option value="">-- Pilih Role --</option>
                <option value="admin">Admin</option>
                <option value="kapus">Kapus</option>
              </select>
            </div>

            <button
              type="submit"
              class="login-button"
              id="registerBtn"
              style="background: #10b981; margin-top: 10px"
            >
              <i class="bi bi-person-plus"></i> Register
            </button>

            <p
              style="
                margin-top: 15px;
                font-size: 12px;
                color: #6b7280;
                text-align: center;
              "
            >
              Setelah registrasi berhasil, silakan login dengan akun yang
              dibuat.
            </p>
          </form>
        </div>

        <!-- Footer -->
        <div class="login-footer">
          <p>Tata Naskah Digital</p>
          <p>Kementerian Pertahanan Republik Indonesia</p>
          <p>Pusat Panggilan: 0812-8595-1569</p>
          <p>Aplikasi ini didukung oleh Balai Sertifikasi Elektronik</p>
          <img src="assets/img/bse.png" alt="BSE Logo" />
        </div>
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="assets/js/firebase-config.js"></script>

    <!-- Auth Functions -->
    <script src="assets/js/auth.js"></script>

    <!-- Login Page Script -->
    <script>
      console.log("üìÑ Login page loaded");

      // ============================================
      // LOADING SCREEN FUNCTIONS
      // ============================================
      window.showLoading = function () {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) {
          loadingScreen.classList.add("show");
        }
      };

      window.hideLoading = function () {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) {
          loadingScreen.classList.remove("show");
        }
      };

      // ============================================
      // PASSWORD TOGGLE
      // ============================================
      const togglePassword = document.getElementById("togglePassword");
      const passwordInput = document.getElementById("password");

      if (togglePassword && passwordInput) {
        togglePassword.addEventListener("click", function () {
          const type = passwordInput.type === "password" ? "text" : "password";
          passwordInput.type = type;

          const icon = this.querySelector("i");
          icon.classList.toggle("bi-eye-slash");
          icon.classList.toggle("bi-eye");
        });
      }

      // ============================================
      // LOGIN FORM HANDLER
      // ============================================
      const loginForm = document.getElementById("loginForm");
      const loginBtn = document.getElementById("loginBtn");

      if (loginForm) {
        loginForm.addEventListener("submit", function (e) {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;

          if (!email || !password) {
            alert("‚ö†Ô∏è Silakan isi email dan password!");
            return;
          }

          // Disable button
          if (loginBtn) {
            loginBtn.disabled = true;
            loginBtn.innerHTML =
              '<i class="bi bi-hourglass-split"></i> Memproses...';
          }

          console.log("üîê Login attempt:", email);

          loginUser(email, password).catch((error) => {
            // Re-enable button jika error
            if (loginBtn) {
              loginBtn.disabled = false;
              loginBtn.innerHTML = "Masuk";
            }
          });
        });
      }

      // ============================================
      // REGISTER FORM HANDLER
      // ============================================
      const registerForm = document.getElementById("registerForm");
      const registerBtn = document.getElementById("registerBtn");

      if (registerForm) {
        registerForm.addEventListener("submit", function (e) {
          e.preventDefault();

          const nama = document.getElementById("nama").value.trim();
          const email = document.getElementById("regEmail").value.trim();
          const password = document.getElementById("regPassword").value;
          const role = document.getElementById("role").value;

          // Validasi
          if (!nama || !email || !password || !role) {
            alert("‚ö†Ô∏è Semua field bertanda * harus diisi!");
            return;
          }

          if (password.length < 6) {
            alert("‚ö†Ô∏è Password minimal 6 karakter!");
            return;
          }

          // Disable button
          if (registerBtn) {
            registerBtn.disabled = true;
            registerBtn.innerHTML =
              '<i class="bi bi-hourglass-split"></i> Memproses...';
          }

          console.log("üìù Register attempt:", { email, role, nama });

          registerUser(email, password, role, nama)
            .then(() => {
              // Clear form
              registerForm.reset();

              // Re-enable button
              if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.innerHTML =
                  '<i class="bi bi-person-plus"></i> Register';
              }

              console.log("‚úÖ Registration completed successfully");
            })
            .catch((error) => {
              console.error("‚ùå Registration failed:", error);

              // Re-enable button
              if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.innerHTML =
                  '<i class="bi bi-person-plus"></i> Register';
              }
            });
        });
      }

      // ============================================
      // CHECK AUTH STATE ON PAGE LOAD
      // ============================================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üîÑ Page loaded - checking auth state...");

        // Check auth state (akan auto-detect ?logout=true)
        setTimeout(() => {
          checkAuthState();
        }, 300);
      });

      // ============================================
      // KEYBOARD SHORTCUTS
      // ============================================
      document
        .getElementById("email")
        ?.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("password")?.focus();
          }
        });

      console.log("‚úÖ Login page scripts loaded");

      // ============================================
      // FORCE LOGOUT SAAT BUKA LOGIN PAGE
      // ============================================
      (function () {
        console.log("üîí Login page loaded - checking for old sessions...");

        // Jika ada user login lama, paksa logout
        const urlParams = new URLSearchParams(window.location.search);
        const isFromLogout = urlParams.get("logout") === "true";
        const freshLogin = sessionStorage.getItem("freshLogin");

        if (!freshLogin || isFromLogout) {
          console.log("üßπ Clearing old session...");

          // Clear storage
          sessionStorage.clear();
          localStorage.clear();

          // Force Firebase logout
          if (window.auth) {
            auth
              .signOut()
              .then(() => {
                return auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
              })
              .then(() => {
                console.log("‚úÖ Old session cleared");
                // Clean URL
                if (isFromLogout) {
                  window.history.replaceState({}, document.title, "login.html");
                }
              })
              .catch((err) => {
                console.error("Clear session error:", err);
              });
          }
        }
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Surat Masuk - Kapus</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/globals.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/dashboard-kapus.css" />
    <style>
      .surat-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      .surat-table th {
        background: #f3f4f6;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
      }
      .surat-table td {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
      }
      .surat-table tbody tr:hover {
        background: #f9fafb;
      }
      .badge-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .badge-tinggi {
        background: #fee2e2;
        color: #991b1b;
      }
      .badge-menunggu {
        background: #fef3c7;
        color: #92400e;
      }
      .badge-selesai {
        background: #d1fae5;
        color: #065f46;
      }
      .btn-disposisi-cepat {
        background: #10b981;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn-disposisi-cepat:hover {
        background: #059669;
      }
      .btn-preview {
        background: #f59e0b;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-right: 8px;
      }
      .btn-preview:hover {
        background: #d97706;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      /* Disposisi View Styles */
      .disposisi-view {
        display: none;
      }
      .disposisi-view.active {
        display: block;
      }
      .breadcrumb-nav {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        gap: 12px;
      }
      .breadcrumb-nav .btn-secondary {
        background: #8b0000;
        border-color: #8b0000;
        color: white;
      }
      .breadcrumb-nav .btn-secondary:hover {
        background: #6b0000;
        border-color: #6b0000;
      }
      .breadcrumb-text {
        color: #6b7280;
        font-size: 14px;
      }
      .breadcrumb-text .separator {
        margin: 0 8px;
        color: #9ca3af;
      }
      .breadcrumb-text .current {
        color: #1f2937;
        font-weight: 500;
      }
      .form-disposisi-panel {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        width: 100%;
      }

      /* Preview View Styles */
      .preview-view {
        display: none;
      }
      .preview-view.active {
        display: block;
      }
      .preview-panel {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        width: 100%;
      }
      .file-preview-section {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 0;
        margin-bottom: 24px;
        overflow: hidden;
      }
      .file-preview-header {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .file-preview-title {
        font-weight: 600;
        color: #1f2937;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .file-preview-actions {
        display: flex;
        gap: 8px;
      }
      .file-preview-actions button {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        color: #374151;
        font-size: 14px;
        transition: all 0.2s;
      }
      .file-preview-actions button:hover {
        background: #f3f4f6;
      }
      .file-preview-content {
        background: #f3f4f6;
        min-height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .file-preview-content iframe {
        width: 100%;
        height: 600px;
        border: none;
        background: white;
      }
      .file-preview-content img {
        max-width: 100%;
        max-height: 600px;
        height: auto;
        object-fit: contain;
      }
      .file-preview-navigation {
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
        padding: 12px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
      }
      .file-preview-navigation button {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #374151;
        transition: all 0.2s;
      }
      .file-preview-navigation button:hover:not(:disabled) {
        background: #f3f4f6;
        border-color: #8b0000;
        color: #8b0000;
      }
      .file-preview-navigation button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .file-preview-section .no-file {
        color: #9ca3af;
        padding: 60px 20px;
        font-size: 14px;
        text-align: center;
      }
      .file-preview-section .no-file i {
        font-size: 48px;
        color: #d1d5db;
        margin-bottom: 12px;
        display: block;
      }
      .panel-header {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e5e7eb;
      }
      .detail-item {
        margin-bottom: 16px;
      }
      .detail-label {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 4px;
        text-transform: uppercase;
      }
      .detail-value {
        font-size: 14px;
        color: #1f2937;
      }
      .checkbox-group {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 16px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px 16px;
      }
      .checkbox-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 8px;
        background: #f9fafb;
        border-radius: 6px;
        transition: all 0.2s;
      }
      .checkbox-item:hover {
        background: #f3f4f6;
      }
      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #8b0000;
        flex-shrink: 0;
        margin-top: 2px;
      }
      .checkbox-item label {
        cursor: pointer;
        margin: 0;
        font-size: 13px;
        flex: 1;
        word-wrap: break-word;
        line-height: 1.4;
        color: #374151;
      }
      .selected-badge {
        display: inline-block;
        background: #8b0000;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-overview">
      <!-- âœ… FIXED: Dynamic Sidebar -->
      <div id="sidebar-placeholder"></div>

      <!-- Main Content -->
      <div class="main-content">
        <div id="header-placeholder"></div>
        <div class="content-container" style="padding: 24px">
          <!-- Table View -->
          <div id="tableView">
            <div class="page-header">
              <h1 style="font-size: 24px; font-weight: 700; margin: 0">
                Surat Masuk - Perlu Tindakan
              </h1>
              <div style="color: #6b7280">
                <i class="bi bi-calendar3"></i>
                <span id="currentDate"></span>
              </div>
            </div>

            <div
              style="
                background: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
              "
            >
              <table class="surat-table">
                <thead>
                  <tr>
                    <th style="width: 50px">No</th>
                    <th>Nomor Surat</th>
                    <th>Perihal</th>
                    <th>Pengirim</th>
                    <th style="width: 120px">Prioritas</th>
                    <th style="width: 150px">Status</th>
                    <th style="width: 200px; text-align: center">
                      Aksi Diperlukan
                    </th>
                  </tr>
                </thead>
                <tbody id="suratMasukTableBody">
                  <tr>
                    <td
                      colspan="7"
                      style="text-align: center; padding: 40px; color: #9ca3af"
                    >
                      Loading data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Preview View -->
          <div id="previewView" class="preview-view">
            <div class="breadcrumb-nav">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="backToTable()"
                style="display: flex; align-items: center; gap: 8px"
              >
                <i class="bi bi-arrow-left"></i> Kembali
              </button>
              <div class="breadcrumb-text">
                <span style="color: #9ca3af">Surat Masuk</span>
                <span class="separator">/</span>
                <span class="current">Preview</span>
              </div>
            </div>

            <div class="preview-panel">
              <div class="panel-header">
                <i class="bi bi-file-earmark-text"></i> Detail Surat Masuk
              </div>

              <!-- File Preview Section -->
              <div class="file-preview-section">
                <div class="file-preview-header">
                  <div class="file-preview-title">
                    <span id="filePreviewTitle"
                      >Pengajuan Magang Mahasiswa Prodi Sistem Informasi</span
                    >
                  </div>
                  <div class="file-preview-actions">
                    <button type="button" onclick="zoomOut()" title="Zoom Out">
                      <i class="bi bi-zoom-out"></i>
                    </button>
                    <button type="button" onclick="zoomIn()" title="Zoom In">
                      <i class="bi bi-zoom-in"></i>
                    </button>
                    <button
                      type="button"
                      onclick="downloadFile()"
                      title="Download"
                    >
                      <i class="bi bi-download"></i>
                    </button>
                  </div>
                </div>
                <div class="file-preview-content" id="filePreviewContent">
                  <div class="no-file">
                    <i class="bi bi-file-earmark"></i>
                    <p>Tidak ada file yang dilampirkan</p>
                  </div>
                </div>
                <div class="file-preview-navigation">
                  <button type="button" id="prevPage" disabled>
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <button type="button" id="nextPage" disabled>
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-label">Nomor Surat</div>
                <div class="detail-value" id="previewNoSurat">-</div>
              </div>

              <div class="detail-item">
                <div class="detail-label">Perihal</div>
                <div class="detail-value" id="previewPerihal">-</div>
              </div>

              <div class="detail-item">
                <div class="detail-label">Pengirim</div>
                <div class="detail-value" id="previewPengirim">-</div>
              </div>

              <div class="detail-item">
                <div class="detail-label">Tanggal Surat</div>
                <div class="detail-value" id="previewTanggalSurat">-</div>
              </div>

              <div class="detail-item">
                <div class="detail-label">Tanggal Diterima</div>
                <div class="detail-value" id="previewTanggalDiterima">-</div>
              </div>

              <div class="detail-item">
                <div class="detail-label">Catatan</div>
                <div class="detail-value" id="previewCatatan">-</div>
              </div>

              <div
                style="
                  display: flex;
                  gap: 12px;
                  margin-top: 24px;
                  padding-top: 16px;
                  border-top: 2px solid #e5e7eb;
                "
              >
                <button
                  class="btn btn-success flex-fill"
                  onclick="disposisiFromPreview()"
                >
                  <i class="bi bi-send"></i> Buat Disposisi
                </button>
              </div>
            </div>
          </div>

          <!-- Disposisi View -->
          <div id="disposisiView" class="disposisi-view">
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb-nav">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="backToTable()"
                style="display: flex; align-items: center; gap: 8px"
              >
                <i class="bi bi-arrow-left"></i> Kembali
              </button>
              <div class="breadcrumb-text">
                <span style="color: #9ca3af">Surat Masuk</span>
                <span class="separator">/</span>
                <span class="current">Disposisi</span>
              </div>
            </div>

            <div class="form-disposisi-panel">
              <div class="panel-header">
                <i class="bi bi-send-fill"></i> Form Disposisi Surat
              </div>

              <div class="mb-3">
                <label
                  class="form-label"
                  style="font-weight: 600; color: #374151"
                  >Perihal Surat:</label
                >
                <p
                  id="detailPerihal"
                  style="
                    color: #1f2937;
                    background: #f3f4f6;
                    padding: 10px;
                    border-radius: 6px;
                  "
                >
                  -
                </p>
              </div>

              <div class="mb-3">
                <label class="form-label">
                  Penerima Disposisi <span class="text-danger">*</span>
                  <span class="selected-badge" id="penerimaCount"
                    >0 dipilih</span
                  >
                </label>
                <div class="checkbox-group">
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima1"
                      name="penerima"
                      value="Kabid Banglola Sisfohan"
                    />
                    <label for="penerima1">Kabid Banglola Sisfohan</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima2"
                      name="penerima"
                      value="Kasubbid Infosan"
                    />
                    <label for="penerima2">Kasubbid Infosan</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima3"
                      name="penerima"
                      value="Kasubbag TU"
                    />
                    <label for="penerima3">Kasubbag TU</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima4"
                      name="penerima"
                      value="Kasubbag MSI"
                    />
                    <label for="penerima4">Kasubbag MSI</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima5"
                      name="penerima"
                      value="Kasubbid Data"
                    />
                    <label for="penerima5">Kasubbid Data</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima6"
                      name="penerima"
                      value="Kabid Informasi"
                    />
                    <label for="penerima6">Kabid Informasi</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima7"
                      name="penerima"
                      value="Kasubbag Keuangan"
                    />
                    <label for="penerima7">Kasubbag Keuangan</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima8"
                      name="penerima"
                      value="Kasubbid Perencanaan"
                    />
                    <label for="penerima8">Kasubbid Perencanaan</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="penerima9"
                      name="penerima"
                      value="Staf Administrasi"
                    />
                    <label for="penerima9">Staf Administrasi</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">
                  Petunjuk Disposisi <span class="text-danger">*</span>
                  <span class="selected-badge" id="petunjukCount"
                    >0 dipilih</span
                  >
                </label>
                <div class="checkbox-group">
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk1"
                      name="petunjuk"
                      value="ACC"
                    />
                    <label for="petunjuk1">ACC</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk2"
                      name="petunjuk"
                      value="Sesuaikan"
                    />
                    <label for="petunjuk2">Sesuaikan</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk3"
                      name="petunjuk"
                      value="Tindaklanjuti"
                    />
                    <label for="petunjuk3">Tindaklanjuti</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk4"
                      name="petunjuk"
                      value="Untuk Diketahui"
                    />
                    <label for="petunjuk4">Untuk Diketahui</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk5"
                      name="petunjuk"
                      value="Koordinasikan"
                    />
                    <label for="petunjuk5">Koordinasikan</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk6"
                      name="petunjuk"
                      value="Segera"
                    />
                    <label for="petunjuk6">Segera</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk7"
                      name="petunjuk"
                      value="Pelajari dan Beri Saran"
                    />
                    <label for="petunjuk7">Pelajari dan Beri Saran</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk8"
                      name="petunjuk"
                      value="Ingatkan"
                    />
                    <label for="petunjuk8">Ingatkan</label>
                  </div>
                  <div class="checkbox-item">
                    <input
                      type="checkbox"
                      id="petunjuk9"
                      name="petunjuk"
                      value="Arsipkan"
                    />
                    <label for="petunjuk9">Arsipkan</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Catatan Tambahan</label>
                <textarea
                  class="form-control"
                  id="disposisiInstruksi"
                  rows="4"
                  placeholder="Masukkan catatan atau instruksi tambahan"
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Prioritas</label>
                <select class="form-select" id="disposisiPrioritas">
                  <option value="Normal">Normal</option>
                  <option value="Penting">Penting</option>
                  <option value="Sangat Penting">Sangat Penting</option>
                </select>
              </div>

              <button
                type="button"
                class="btn btn-success w-100"
                onclick="submitDisposisiCepat()"
              >
                <i class="bi bi-send-fill"></i> Kirim Disposisi
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/database.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
      // ==========================================
      // âœ… SURAT MASUK KAPUS - FIXED VERSION WITH DYNAMIC SIDEBAR
      // ==========================================

      let currentUserData = null;
      let currentSuratId = null;
      let unsubscribeSuratMasuk = null;

      console.log("ðŸ“„ Surat Masuk Kapus page loading...");

      // âœ… STEP 1: Check Auth First
      checkUserRole(["kapus"])
        .then((userData) => {
          currentUserData = userData;
          console.log("âœ… Kapus authenticated:", userData.nama);

          // âœ… STEP 2: Load Sidebar & Header
          if (window.loadIncludes) {
            window.loadIncludes();
          }

          // âœ… STEP 3: Wait for sidebar to load, THEN initialize
          setTimeout(() => {
            initializePage();
          }, 500);
        })
        .catch((error) => {
          console.error("âŒ Access denied:", error);
        });

      // ==========================================
      // âœ… INITIALIZE PAGE DATA
      // ==========================================
      function initializePage() {
        console.log("ðŸš€ Initializing page data...");

        // Update sidebar username
        const sidebarUserName = document.getElementById("sidebarUserName");
        if (sidebarUserName) {
          sidebarUserName.textContent = currentUserData.nama || "Kapus";
        }

        // Update header user info
        const userNameDisplay = document.getElementById("userNameDisplay");
        const userRoleDisplay = document.getElementById("userRoleDisplay");
        const dropdownUserName = document.getElementById("dropdownUserName");
        const dropdownUserRole = document.getElementById("dropdownUserRole");

        if (userNameDisplay) {
          userNameDisplay.textContent = currentUserData.nama || "Kapus";
        }
        if (userRoleDisplay) {
          userRoleDisplay.textContent = "Kepala Pusat";
        }
        if (dropdownUserName) {
          dropdownUserName.textContent = currentUserData.nama || "Kapus";
        }
        if (dropdownUserRole) {
          dropdownUserRole.textContent = "Kepala Pusat";
        }

        // Set current date
        const currentDateEl = document.getElementById("currentDate");
        if (currentDateEl) {
          currentDateEl.textContent = new Date().toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric",
          });
        }

        // Setup checkbox counters
        setupCheckboxCounters();

        // Setup real-time listener
        setupRealtimeListener();

        // Setup logout handler
        setupLogoutHandler();

        console.log("âœ… Page initialized successfully");
      }

      // ==========================================
      // SETUP CHECKBOX COUNTERS
      // ==========================================
      function setupCheckboxCounters() {
        const penerimaCheckboxes = document.querySelectorAll(
          'input[name="penerima"]'
        );
        const petunjukCheckboxes = document.querySelectorAll(
          'input[name="petunjuk"]'
        );

        penerimaCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", updatePenerimaCount);
        });

        petunjukCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", updatePetunjukCount);
        });

        console.log("âœ… Checkbox counters setup");
      }

      function updatePenerimaCount() {
        const checked = document.querySelectorAll(
          'input[name="penerima"]:checked'
        ).length;
        const countEl = document.getElementById("penerimaCount");
        if (countEl) countEl.textContent = checked + " dipilih";
      }

      function updatePetunjukCount() {
        const checked = document.querySelectorAll(
          'input[name="petunjuk"]:checked'
        ).length;
        const countEl = document.getElementById("petunjukCount");
        if (countEl) countEl.textContent = checked + " dipilih";
      }

      // ==========================================
      // SETUP REAL-TIME LISTENER
      // ==========================================
      function setupRealtimeListener() {
        console.log("ðŸ”„ Setting up real-time listener...");

        if (unsubscribeSuratMasuk) {
          unsubscribeSuratMasuk();
        }

        unsubscribeSuratMasuk = db
          .collection("surat_masuk")
          .where("isDeleted", "==", false)
          .where("status", "==", "Terkirim ke Kapus")
          .orderBy("createdAt", "desc")
          .onSnapshot(
            (snapshot) => {
              console.log("ðŸ“¨ Surat Masuk updated:", snapshot.size);
              loadSuratMasuk(snapshot);
            },
            (error) => {
              console.error("âŒ Error listening:", error);
            }
          );
      }

      // ==========================================
      // LOAD SURAT MASUK
      // ==========================================
      function loadSuratMasuk(snapshot) {
        const tbody = document.getElementById("suratMasukTableBody");
        if (!tbody) return;

        const suratKapus = [];
        snapshot.forEach((doc) => {
          suratKapus.push({
            id: doc.id,
            ...doc.data(),
          });
        });

        if (suratKapus.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #9ca3af;">
                Tidak ada surat yang perlu ditindaklanjuti
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = suratKapus
          .map(
            (surat, index) => `
          <tr>
            <td style="text-align: center;">${index + 1}</td>
            <td>${surat.noSurat || "-"}</td>
            <td>${surat.perihal || "-"}</td>
            <td>${surat.dari || surat.namaPengirim || "-"}</td>
            <td><span class="badge-status badge-tinggi">Tinggi</span></td>
            <td><span class="badge-status badge-menunggu">Menunggu</span></td>
            <td style="text-align: center;">
              <button class="btn-preview" onclick="previewSurat('${surat.id}')">
                <i class="bi bi-eye"></i> Preview
              </button>
              <button class="btn-disposisi-cepat" onclick="buatDisposisiCepat('${
                surat.id
              }')">
                <i class="bi bi-send"></i> Disposisi
              </button>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // ==========================================
      // PREVIEW & DISPOSISI FUNCTIONS
      // ==========================================
      window.previewSurat = function (suratId) {
        db.collection("surat_masuk")
          .doc(suratId)
          .get()
          .then((doc) => {
            if (!doc.exists) {
              Swal.fire("Error", "Surat tidak ditemukan", "error");
              return;
            }

            const surat = doc.data();
            currentSuratId = suratId;

            document.getElementById("previewNoSurat").textContent =
              surat.noSurat || "-";
            document.getElementById("previewPerihal").textContent =
              surat.perihal || "-";
            document.getElementById("previewPengirim").textContent =
              surat.dari || surat.namaPengirim || "-";
            document.getElementById("previewTanggalSurat").textContent =
              surat.tanggalSurat || "-";
            document.getElementById("previewTanggalDiterima").textContent =
              surat.tanggalDiterima || "-";
            document.getElementById("previewCatatan").textContent =
              surat.catatan || "-";

            document.getElementById("tableView").style.display = "none";
            document.getElementById("disposisiView").classList.remove("active");
            document.getElementById("previewView").classList.add("active");
          });
      };

      window.buatDisposisiCepat = function (suratId) {
        currentSuratId = suratId;

        db.collection("surat_masuk")
          .doc(suratId)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const surat = doc.data();

              document.getElementById("detailPerihal").textContent =
                surat.perihal || "-";

              // Reset form
              document
                .querySelectorAll('input[name="penerima"]')
                .forEach((cb) => (cb.checked = false));
              document
                .querySelectorAll('input[name="petunjuk"]')
                .forEach((cb) => (cb.checked = false));
              document.getElementById("disposisiInstruksi").value = "";
              document.getElementById("disposisiPrioritas").value = "Normal";
              updatePenerimaCount();
              updatePetunjukCount();

              // Switch view
              document.getElementById("tableView").style.display = "none";
              document.getElementById("previewView").classList.remove("active");
              document.getElementById("disposisiView").classList.add("active");
            }
          });
      };

      window.backToTable = function () {
        document.getElementById("tableView").style.display = "block";
        document.getElementById("disposisiView").classList.remove("active");
        document.getElementById("previewView").classList.remove("active");
        currentSuratId = null;
      };

      window.disposisiFromPreview = function () {
        if (currentSuratId) {
          document.getElementById("previewView").classList.remove("active");
          buatDisposisiCepat(currentSuratId);
        }
      };

      // ==========================================
      // SUBMIT DISPOSISI
      // ==========================================
      window.submitDisposisiCepat = function () {
        const penerima = Array.from(
          document.querySelectorAll('input[name="penerima"]:checked')
        ).map((cb) => cb.value);
        const petunjuk = Array.from(
          document.querySelectorAll('input[name="petunjuk"]:checked')
        ).map((cb) => cb.value);
        const instruksi = document
          .getElementById("disposisiInstruksi")
          .value.trim();
        const prioritas = document.getElementById("disposisiPrioritas").value;

        // Validation
        if (penerima.length === 0) {
          Swal.fire("Error", "Pilih minimal 1 penerima disposisi!", "error");
          return;
        }

        if (petunjuk.length === 0) {
          Swal.fire("Error", "Pilih minimal 1 petunjuk disposisi!", "error");
          return;
        }

        if (!currentSuratId) {
          Swal.fire("Error", "Surat tidak ditemukan!", "error");
          return;
        }

        Swal.fire({
          title: "Mengirim Disposisi...",
          html: "Mohon tunggu sebentar",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        const now = new Date();
        const disposisi = {
          kepada: penerima.join(", "),
          judul: petunjuk.join(", "),
          instruksi: instruksi,
          prioritas: prioritas,
          dari: currentUserData.nama,
          jabatanDari: "Kepala Pusat",
          tanggal: now.toISOString(),
          status: "Proses",
          createdAt: now.toISOString(),
        };

        db.collection("surat_masuk")
          .doc(currentSuratId)
          .update({
            status: "Selesai - Sudah Didisposisi",
            processedBy: currentUserData.nama,
            processedByEmail: currentUserData.email || "",
            processedAt: firebase.firestore.FieldValue.serverTimestamp(),
            disposisi: firebase.firestore.FieldValue.arrayUnion(disposisi),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          })
          .then(() => {
            Swal.fire({
              icon: "success",
              title: "Disposisi Berhasil Dikirim!",
              html: `Disposisi telah dikirim ke: <strong>${penerima.join(
                ", "
              )}</strong>`,
              confirmButtonText: "OK",
              confirmButtonColor: "#10b981",
              timer: 3000,
              timerProgressBar: true,
            }).then(() => {
              backToTable();
            });
          })
          .catch((error) => {
            console.error("âŒ Error:", error);
            Swal.fire(
              "Error",
              "Gagal mengirim disposisi: " + error.message,
              "error"
            );
          });
      };

      // ==========================================
      // SETUP LOGOUT HANDLER
      // ==========================================
      function setupLogoutHandler() {
        const logoutLink = document.getElementById("logoutLink");
        if (logoutLink) {
          logoutLink.addEventListener("click", function (e) {
            e.preventDefault();
            Swal.fire({
              title: "Yakin ingin logout?",
              icon: "warning",
              showCancelButton: true,
              confirmButtonText: "Ya, logout",
              cancelButtonText: "Batal",
              confirmButtonColor: "#d33",
            }).then((result) => {
              if (result.isConfirmed && window.logoutUser) {
                window.logoutUser();
              }
            });
          });
          console.log("âœ… Logout handler attached");
        }
      }

      // ==========================================
      // CLEANUP
      // ==========================================
      window.addEventListener("beforeunload", () => {
        if (unsubscribeSuratMasuk) {
          unsubscribeSuratMasuk();
        }
      });

      // ==========================================
      // AUTO-OPEN FROM URL PARAMS
      // ==========================================
      (function () {
        const urlParams = new URLSearchParams(window.location.search);
        const previewId = urlParams.get("preview");
        const disposisiId = urlParams.get("disposisi");

        if (previewId || disposisiId) {
          window.addEventListener("load", function () {
            setTimeout(() => {
              if (previewId && typeof previewSurat === "function") {
                previewSurat(previewId);
              } else if (
                disposisiId &&
                typeof buatDisposisiCepat === "function"
              ) {
                buatDisposisiCepat(disposisiId);
              }
            }, 800);
          });
        }
      })();

      console.log(
        "âœ… Surat Masuk Kapus loaded - FIXED VERSION WITH DYNAMIC SIDEBAR"
      );
    </script>
  </body>
</html>
